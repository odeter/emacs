import psycopg2
import time
from psycopg2 import Error

@pytest.fixture(scope='session', autouse=True)
def my_docker_db(session_scoped_container_getter):

    ## wait for the db to become aviable, e.g for the docker to startup
    connection = None
    for _ in range(5):
        try:
            # Connect to an existing database
            connection = psycopg2.connect(user="testing",
                                          password="testing",
                                          host="0.0.0.0",
                                          port="5434",
                                          database="postgres")
            break
        except (Exception, Error) as error:
            print("Error while connecting to PostgreSQL", error)
            time.sleep(5)
            continue
        finally:
            if (connection):
                connection.close()
                print("PostgreSQL connection is closed")

    yield session_scoped_container_getter

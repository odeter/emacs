#!/bin/bash
# A simple script

function run_fun {
    flock -n -x $1 -c "if python3 format_data.py $1 $(basename $(dirname $(dirname "$1"))) $(basename $(dirname "$1")); then mkdir -p $DDIR$(basename $(dirname "$1"))/ && mv $1 $DDIR$(basename $(dirname "$1")); else mkdir -p $PDIR$(basename $(dirname "$1"))/ && mv $1 $PDIR$(basename $(dirname "$1"))/; fi"
    return 0
}

if [ "$1" != "" ]; then
    export -f run_fun
    export PDIR="package_probs/"
    export DDIR="package_done/"
    export DATABASE_URL=postgresql://db_master:1234@localhost/angle_db
    ## get port and login from dokku
    #export EXPORT=`dokku postgres:info angle_db --exposed-ports | sed 's/[0-9]*->//g' | sed 's/[[:space:]]//g'`
    #export DATABASE_URL=`dokku postgres:info angle_db --dsn | sed "s/@[a-z -]*:['0-9']*/@localhost:$EXPORT/g"`

    mkdir -p $PDIR
    mkdir -p $DDIR
    #source bin/activate
    while :
    do
        find "$1" -name "*.gz" -type f | xargs -n 1 -P 8 -I {} bash -c 'run_fun "$@"' _ {}
        sleep 5
    done
else
    echo "first parameter needs to contain path to data"
    exit 1
fi

from angle import check_api
from angle.models import db, UserModel, SensorModel, FirmModel, RoleModel
from flask_restful import Resource
from flask import current_app as app
from .send_sms import send_sms
import datetime
from datetime import datetime as dt
import phonenumbers as pn

class sensorSMS(Resource):
    @check_api("SMSKEY")
    def post(self):
        sensor_time = app.config['SENSOR_TIMELAPS'] * 60

        minTime = dt.now() - datetime.timedelta(seconds=sensor_time)

        users = db.session.query(UserModel, SensorModel).join(FirmModel).join(SensorModel).filter((SensorModel.sent_sms == None) & ((SensorModel.last_entry < minTime) | (SensorModel.last_entry == None))).filter(UserModel.roles.any(RoleModel.un == 'admin')).all()

        for i in users:
            number = pn.parse(i[0].mobile, i[0].country_code)
            if pn.is_valid_number(number):
                send_sms("Sensor {0} is inactive".format(i[1].name), [str(number.country_code) + str(number.national_number)])
                i[1].sent_sms = dt.now()
                i[1].save_to_db()

        return {'message': 'Sent SMS'}, 200


